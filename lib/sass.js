"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const s = require("node-sass");
const dopees_chain_1 = require("dopees-chain");
const fs = require("fs");
const fspath = require("path");
const fsp = fs.promises;
// const fileStat = (path: string): Promise<fs.Stats> => new Promise((resolve, reject) => fs.stat(path, (err, stats) => err ? reject(err) : resolve(stats)));
const fileExists = (path) => fsp.access(path).then(() => true, () => false);
const sassRender = (options) => new Promise((resolve, reject) => s.render(options, (err, result) => {
    if (err) {
        reject(err);
    }
    else {
        resolve(result);
    }
}));
const resolveDependency = async (rootPath, path, includePaths) => {
    let folder;
    let fname;
    if (path.includes(fspath.sep)) {
        folder = fspath.dirname(path);
        fname = fspath.basename(path);
    }
    else {
        folder = '';
        fname = path;
    }
    if (!fname.endsWith('.scss')) {
        fname = fname + '.scss';
    }
    for (const basePath of includePaths) {
        let candidate = fspath.normalize(fspath.join(basePath, folder, fname));
        if (await fileExists(candidate)) {
            return candidate;
        }
        if (!fname.startsWith('_')) {
            candidate = fspath.normalize(fspath.join(basePath, folder, '_' + fname));
            if (await fileExists(candidate)) {
                return candidate;
            }
        }
    }
    throw new Error(`could not resolve ${path} while processing ${rootPath}, search paths: ${includePaths}`);
};
const getMatches = (regex, input) => {
    const result = [];
    for (let m = regex.exec(input); m; m = regex.exec(input)) {
        result.push(m);
    }
    return result;
};
class SassMapperState {
    constructor(options) {
        this.sourceResolver = dopees_chain_1.ReversePathResolver.from(options);
        this.innerStateKey = 'sass.innerState';
        const extension = `.${options.targetExt || 'css'}`;
        this.selector = (path, context) => {
            const absoluteTargetRoot = fspath.normalize(fspath.join(context.basePath, options.targetRoot));
            return path.endsWith(extension) && dopees_chain_1.PathResolver.match(path, absoluteTargetRoot, options.subfolders);
        };
        this.outputStyle = options.outputStyle;
        this.precision = options.precision;
        this.production = true === options.production;
    }
}
exports.SassMapperState = SassMapperState;
class SassMapper extends dopees_chain_1.derived.FileMapper {
    constructor() {
        super(...arguments);
        this.name = 'sass';
    }
    async generate(state, task, innerState, _) {
        console.warn(state.production);
        const options = {
            outputStyle: state.outputStyle || 'compressed',
            precision: state.precision,
            file: innerState.sourcePath,
            data: innerState.sourceCode,
            outFile: task.name.path,
            sourceMap: !state.production,
            sourceMapContents: !state.production,
            sourceMapEmbed: !state.production
        };
        const sassResult = await sassRender(options);
        return sassResult.css;
    }
    async readSource(_, task, context) {
        const code = await context.getContents(task, 'utf-8');
        return {
            sourceCode: code,
            sourcePath: task.name.path
        };
    }
    init(options) { return new SassMapperState(options); }
}
exports.SassMapper = SassMapper;
class SassDependencyResolver extends dopees_chain_1.derived.FileDependencyResolver {
    constructor() {
        super(...arguments);
        this.name = 'sass:deps';
    }
    async readSource(_, task, context) {
        const code = await context.getContents(task, 'utf-8');
        return {
            sourceCode: code,
            sourcePath: task.name.path
        };
    }
    async readDependencies(_, task, innerState, context) {
        const folder = fspath.dirname(innerState.sourcePath);
        return await Promise.all(getMatches(/^@import '(.*)';?$/mg, innerState.sourceCode)
            .map(m => m[1])
            .map(relative => resolveDependency(folder, relative, [folder]))); // FIXME: includePaths
    }
    init(options) {
        const extension = `.${options.sourceExt || 'scss'}`;
        return {
            selector: (path) => path.endsWith(extension),
            dependenciesKey: 'sass.dependencies',
            innerStateKey: 'sass.innerState'
        };
    }
}
exports.SassDependencyResolver = SassDependencyResolver;
function sass(options) {
    if (!options) {
        throw new Error('targetRoot must be specified');
    }
    // FIXME: propagate
    // const includePaths = opts.includePaths || [];
    const sassExecutor = new SassMapper().createExecutor(options);
    const sassDepsExecutor = new SassDependencyResolver().createExecutor(options);
    return dopees_chain_1.Executors.combine(sassExecutor, sassDepsExecutor);
}
exports.sass = sass;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Fzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zYXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQStCO0FBQy9CLCtDQUFpSztBQUNqSyx5QkFBeUI7QUFDekIsK0JBQStCO0FBRS9CLE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUM7QUFFeEIsNkpBQTZKO0FBRTdKLE1BQU0sVUFBVSxHQUFHLENBQUMsSUFBWSxFQUFvQixFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBRXRHLE1BQU0sVUFBVSxHQUFHLENBQUMsT0FBa0IsRUFBcUIsRUFBRSxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLEVBQUU7SUFDL0gsSUFBSSxHQUFHLEVBQUU7UUFDUCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDYjtTQUFNO1FBQ0wsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0tBQ2pCO0FBQ0gsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUVILE1BQU0saUJBQWlCLEdBQUcsS0FBSyxFQUFFLFFBQWUsRUFBRSxJQUFZLEVBQUUsWUFBc0IsRUFBRSxFQUFFO0lBQ3hGLElBQUksTUFBYyxDQUFDO0lBQ25CLElBQUksS0FBYSxDQUFDO0lBQ2xCLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDN0IsTUFBTSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUIsS0FBSyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7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LG1CQUFtQjtJQUNuQixnREFBZ0Q7SUFDaEQsTUFBTSxZQUFZLEdBQUcsSUFBSSxVQUFVLEVBQUUsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDOUQsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLHNCQUFzQixFQUFFLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzlFLE9BQU8sd0JBQVMsQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLGdCQUFnQixDQUFDLENBQUM7QUFDM0QsQ0FBQztBQVRELG9CQVNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcyBmcm9tICdub2RlLXNhc3MnO1xuaW1wb3J0IHsgRXhlY3V0b3IsIFRhc2ssIENvbnRleHQsIEZpbGVOYW1lLCBIZWxwZXJzIGFzIGgsIFJldmVyc2VQYXRoUmVzb2x2ZXJDb25maWcsIFJldmVyc2VQYXRoUmVzb2x2ZXIsIGRlcml2ZWQsIFBhdGhSZXNvbHZlciwgRXhlY3V0b3JzIH0gZnJvbSAnZG9wZWVzLWNoYWluJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIGZzcGF0aCBmcm9tICdwYXRoJztcblxuY29uc3QgZnNwID0gZnMucHJvbWlzZXM7XG5cbi8vIGNvbnN0IGZpbGVTdGF0ID0gKHBhdGg6IHN0cmluZyk6IFByb21pc2U8ZnMuU3RhdHM+ID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IGZzLnN0YXQocGF0aCwgKGVyciwgc3RhdHMpID0+IGVyciA/IHJlamVjdChlcnIpIDogcmVzb2x2ZShzdGF0cykpKTtcblxuY29uc3QgZmlsZUV4aXN0cyA9IChwYXRoOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+ID0+IGZzcC5hY2Nlc3MocGF0aCkudGhlbigoKSA9PiB0cnVlLCAoKSA9PiBmYWxzZSk7XG5cbmNvbnN0IHNhc3NSZW5kZXIgPSAob3B0aW9uczogcy5PcHRpb25zKTogUHJvbWlzZTxzLlJlc3VsdD4gPT4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gcy5yZW5kZXIob3B0aW9ucywgKGVyciwgcmVzdWx0KSA9PiB7XG4gIGlmIChlcnIpIHtcbiAgICByZWplY3QoZXJyKTtcbiAgfSBlbHNlIHtcbiAgICByZXNvbHZlKHJlc3VsdCk7XG4gIH1cbn0pKVxuXG5jb25zdCByZXNvbHZlRGVwZW5kZW5jeSA9IGFzeW5jIChyb290UGF0aDpzdHJpbmcsIHBhdGg6IHN0cmluZywgaW5jbHVkZVBhdGhzOiBzdHJpbmdbXSkgPT4ge1xuICBsZXQgZm9sZGVyOiBzdHJpbmc7XG4gIGxldCBmbmFtZTogc3RyaW5nO1xuICBpZiAocGF0aC5pbmNsdWRlcyhmc3BhdGguc2VwKSkge1xuICAgIGZvbGRlciA9IGZzcGF0aC5kaXJuYW1lKHBhdGgpO1xuICAgIGZuYW1lID0gZnNwYXRoLmJhc2VuYW1lKHBhdGgpO1xuICB9IGVsc2Uge1xuICAgIGZvbGRlciA9ICcnO1xuICAgIGZuYW1lID0gcGF0aDtcbiAgfVxuICBpZiAoIWZuYW1lLmVuZHNXaXRoKCcuc2NzcycpKSB7XG4gICAgZm5hbWUgPSBmbmFtZSArICcuc2Nzcyc7XG4gIH1cbiAgZm9yIChjb25zdCBiYXNlUGF0aCBvZiBpbmNsdWRlUGF0aHMpIHtcbiAgICBsZXQgY2FuZGlkYXRlID0gZnNwYXRoLm5vcm1hbGl6ZShmc3BhdGguam9pbihiYXNlUGF0aCwgZm9sZGVyLCBmbmFtZSkpO1xuICAgIGlmIChhd2FpdCBmaWxlRXhpc3RzKGNhbmRpZGF0ZSkpIHtcbiAgICAgIHJldHVybiBjYW5kaWRhdGU7XG4gICAgfVxuICAgIGlmICghZm5hbWUuc3RhcnRzV2l0aCgnXycpKSB7XG4gICAgICBjYW5kaWRhdGUgPSBmc3BhdGgubm9ybWFsaXplKGZzcGF0aC5qb2luKGJhc2VQYXRoLCBmb2xkZXIsICdfJyArIGZuYW1lKSk7XG4gICAgICBpZiAoYXdhaXQgZmlsZUV4aXN0cyhjYW5kaWRhdGUpKSB7XG4gICAgICAgIHJldHVybiBjYW5kaWRhdGU7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHRocm93IG5ldyBFcnJvcihgY291bGQgbm90IHJlc29sdmUgJHtwYXRofSB3aGlsZSBwcm9jZXNzaW5nICR7cm9vdFBhdGh9LCBzZWFyY2ggcGF0aHM6ICR7aW5jbHVkZVBhdGhzfWApO1xufVxuXG5jb25zdCBnZXRNYXRjaGVzID0gKHJlZ2V4OiBSZWdFeHAsIGlucHV0OiBzdHJpbmcpID0+IHtcbiAgY29uc3QgcmVzdWx0ID0gW107XG4gIGZvciAobGV0IG0gPSByZWdleC5leGVjKGlucHV0KTsgbTsgbSA9IHJlZ2V4LmV4ZWMoaW5wdXQpKSB7XG4gICAgcmVzdWx0LnB1c2gobSk7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuaW50ZXJmYWNlIERlcGVuZGVuY2llcyB7XG4gIHJlYWRvbmx5IG10aW1lOiBEYXRlO1xuICByZWFkb25seSBkZXBzOiBzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBPcHRpb25zIGV4dGVuZHMgUmV2ZXJzZVBhdGhSZXNvbHZlckNvbmZpZyB7XG4gIHRhcmdldFJvb3Q6IHN0cmluZztcbiAgc3ViZm9sZGVycz86IGJvb2xlYW47XG4gIC8vc291cmNlUmVzb2x2ZXI/OiAocGF0aDogc3RyaW5nLCBiYXNlUGF0aD86IHN0cmluZykgPT4gc3RyaW5nO1xuICBpbmNsdWRlUGF0aHM/OiBzdHJpbmdbXTtcbiAgb3V0cHV0U3R5bGU/OiBcImNvbXBhY3RcIiB8IFwiY29tcHJlc3NlZFwiIHwgXCJleHBhbmRlZFwiIHwgXCJuZXN0ZWRcIjtcbiAgcHJlY2lzaW9uPzogbnVtYmVyO1xuICBwZXJzaXN0cz86IGJvb2xlYW47XG4gIHByb2R1Y3Rpb24/OiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgU2Fzc01hcHBlclN0YXRlIGltcGxlbWVudHMgZGVyaXZlZC5GaWxlTWFwcGVyU3RhdGUge1xuICBzb3VyY2VSZXNvbHZlcjogUGF0aFJlc29sdmVyO1xuICBpbm5lclN0YXRlS2V5OiBzdHJpbmc7XG4gIHNlbGVjdG9yOiAocGF0aDogc3RyaW5nLCBjb250ZXh0OiBDb250ZXh0KSA9PiBib29sZWFuO1xuICBvdXRwdXRTdHlsZT86IFwiY29tcGFjdFwiIHwgXCJjb21wcmVzc2VkXCIgfCBcImV4cGFuZGVkXCIgfCBcIm5lc3RlZFwiO1xuICBwcmVjaXNpb24/OiBudW1iZXI7XG4gIHByb2R1Y3Rpb246IGJvb2xlYW47XG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IE9wdGlvbnMpIHtcbiAgICB0aGlzLnNvdXJjZVJlc29sdmVyID0gUmV2ZXJzZVBhdGhSZXNvbHZlci5mcm9tKG9wdGlvbnMpO1xuICAgIHRoaXMuaW5uZXJTdGF0ZUtleSA9ICdzYXNzLmlubmVyU3RhdGUnO1xuICAgIGNvbnN0IGV4dGVuc2lvbiA9IGAuJHtvcHRpb25zLnRhcmdldEV4dCB8fCAnY3NzJ31gO1xuICAgIHRoaXMuc2VsZWN0b3IgPSAocGF0aDogc3RyaW5nLCBjb250ZXh0OiBDb250ZXh0KSA9PiB7XG4gICAgICBjb25zdCBhYnNvbHV0ZVRhcmdldFJvb3QgPSBmc3BhdGgubm9ybWFsaXplKGZzcGF0aC5qb2luKGNvbnRleHQuYmFzZVBhdGgsIG9wdGlvbnMudGFyZ2V0Um9vdCkpO1xuICAgICAgcmV0dXJuIHBhdGguZW5kc1dpdGgoZXh0ZW5zaW9uKSAmJiBQYXRoUmVzb2x2ZXIubWF0Y2gocGF0aCwgYWJzb2x1dGVUYXJnZXRSb290LCBvcHRpb25zLnN1YmZvbGRlcnMpO1xuICAgIH07XG4gICAgdGhpcy5vdXRwdXRTdHlsZSA9IG9wdGlvbnMub3V0cHV0U3R5bGU7XG4gICAgdGhpcy5wcmVjaXNpb24gPSBvcHRpb25zLnByZWNpc2lvblxuICAgIHRoaXMucHJvZHVjdGlvbiA9IHRydWUgPT09IG9wdGlvbnMucHJvZHVjdGlvbjtcbiAgfVxufVxuXG5pbnRlcmZhY2UgU2Fzc0lubmVyU3RhdGUge1xuICByZWFkb25seSBzb3VyY2VDb2RlOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHNvdXJjZVBhdGg6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIFNhc3NNYXBwZXIgZXh0ZW5kcyBkZXJpdmVkLkZpbGVNYXBwZXI8T3B0aW9ucywgU2Fzc0lubmVyU3RhdGUsIFNhc3NNYXBwZXJTdGF0ZT4gIHtcbiAgbmFtZSA9ICdzYXNzJztcbiAgcHJvdGVjdGVkIGFzeW5jIGdlbmVyYXRlKHN0YXRlOiBTYXNzTWFwcGVyU3RhdGUsIHRhc2s6IFRhc2ssIGlubmVyU3RhdGU6IFNhc3NJbm5lclN0YXRlLCBfOiBDb250ZXh0KSB7XG4gICAgY29uc29sZS53YXJuKHN0YXRlLnByb2R1Y3Rpb24pO1xuICAgIGNvbnN0IG9wdGlvbnMgOiBzLk9wdGlvbnMgPSB7XG4gICAgICBvdXRwdXRTdHlsZTogc3RhdGUub3V0cHV0U3R5bGUgfHwgJ2NvbXByZXNzZWQnLFxuICAgICAgcHJlY2lzaW9uOiBzdGF0ZS5wcmVjaXNpb24sXG4gICAgICBmaWxlOiBpbm5lclN0YXRlLnNvdXJjZVBhdGgsXG4gICAgICBkYXRhOiBpbm5lclN0YXRlLnNvdXJjZUNvZGUsXG4gICAgICBvdXRGaWxlOiAoPEZpbGVOYW1lPnRhc2submFtZSkucGF0aCxcbiAgICAgIHNvdXJjZU1hcDogIXN0YXRlLnByb2R1Y3Rpb24sXG4gICAgICBzb3VyY2VNYXBDb250ZW50czogIXN0YXRlLnByb2R1Y3Rpb24sXG4gICAgICBzb3VyY2VNYXBFbWJlZDogIXN0YXRlLnByb2R1Y3Rpb25cbiAgICB9O1xuICAgIGNvbnN0IHNhc3NSZXN1bHQgPSBhd2FpdCBzYXNzUmVuZGVyKG9wdGlvbnMpO1xuICAgIHJldHVybiBzYXNzUmVzdWx0LmNzcztcbiAgfVxuICBwcm90ZWN0ZWQgYXN5bmMgcmVhZFNvdXJjZShfOiBTYXNzTWFwcGVyU3RhdGUsIHRhc2s6IFRhc2ssIGNvbnRleHQ6IENvbnRleHQpIHtcbiAgICBjb25zdCBjb2RlID0gYXdhaXQgY29udGV4dC5nZXRDb250ZW50cyh0YXNrLCAndXRmLTgnKTtcbiAgICByZXR1cm4ge1xuICAgICAgc291cmNlQ29kZTogY29kZSxcbiAgICAgIHNvdXJjZVBhdGg6ICg8RmlsZU5hbWU+dGFzay5uYW1lKS5wYXRoXG4gICAgfTtcbiAgfVxuICBwcm90ZWN0ZWQgaW5pdChvcHRpb25zOiBPcHRpb25zKTogU2Fzc01hcHBlclN0YXRlIHsgcmV0dXJuIG5ldyBTYXNzTWFwcGVyU3RhdGUob3B0aW9ucyk7IH1cbn1cblxuZXhwb3J0IGNsYXNzIFNhc3NEZXBlbmRlbmN5UmVzb2x2ZXIgZXh0ZW5kcyBkZXJpdmVkLkZpbGVEZXBlbmRlbmN5UmVzb2x2ZXI8eyBzb3VyY2VFeHQ/OiBzdHJpbmcgfSwgU2Fzc0lubmVyU3RhdGUsIGRlcml2ZWQuRmlsZURlcGVuZGVuY3lSZXNvbHZlclN0YXRlICYgeyBpbm5lclN0YXRlS2V5OiBzdHJpbmcsIGRlcGVuZGVuY2llc0tleTogc3RyaW5nIH0+IHtcbiAgbmFtZSA9ICdzYXNzOmRlcHMnO1xuICBwcm90ZWN0ZWQgYXN5bmMgcmVhZFNvdXJjZShfOiBkZXJpdmVkLkZpbGVEZXBlbmRlbmN5UmVzb2x2ZXJTdGF0ZSAmIHsgaW5uZXJTdGF0ZUtleTogc3RyaW5nOyBkZXBlbmRlbmNpZXNLZXk6IHN0cmluZzsgfSwgdGFzazogVGFzaywgY29udGV4dDogQ29udGV4dCk6IFByb21pc2U8U2Fzc0lubmVyU3RhdGU+IHtcbiAgICBjb25zdCBjb2RlID0gYXdhaXQgY29udGV4dC5nZXRDb250ZW50cyh0YXNrLCAndXRmLTgnKTtcbiAgICByZXR1cm4ge1xuICAgICAgc291cmNlQ29kZTogY29kZSxcbiAgICAgIHNvdXJjZVBhdGg6ICg8RmlsZU5hbWU+dGFzay5uYW1lKS5wYXRoXG4gICAgfTtcbiAgfVxuICBwcm90ZWN0ZWQgYXN5bmMgcmVhZERlcGVuZGVuY2llcyhfOiBkZXJpdmVkLkZpbGVEZXBlbmRlbmN5UmVzb2x2ZXJTdGF0ZSAmIHsgaW5uZXJTdGF0ZUtleTogc3RyaW5nOyBkZXBlbmRlbmNpZXNLZXk6IHN0cmluZzsgfSwgdGFzazogVGFzaywgaW5uZXJTdGF0ZTogU2Fzc0lubmVyU3RhdGUsIGNvbnRleHQ6IENvbnRleHQpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgZm9sZGVyID0gZnNwYXRoLmRpcm5hbWUoaW5uZXJTdGF0ZS5zb3VyY2VQYXRoKTtcbiAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5hbGwoZ2V0TWF0Y2hlcygvXkBpbXBvcnQgJyguKiknOz8kL21nLCBpbm5lclN0YXRlLnNvdXJjZUNvZGUpXG4gICAgICAubWFwKG0gPT4gbVsxXSlcbiAgICAgIC5tYXAocmVsYXRpdmUgPT4gcmVzb2x2ZURlcGVuZGVuY3koZm9sZGVyLCByZWxhdGl2ZSwgWyBmb2xkZXIgXSkpKTsgLy8gRklYTUU6IGluY2x1ZGVQYXRoc1xuICB9XG4gIHByb3RlY3RlZCBpbml0KG9wdGlvbnM6IHsgc291cmNlRXh0Pzogc3RyaW5nIH0pOiBkZXJpdmVkLkZpbGVEZXBlbmRlbmN5UmVzb2x2ZXJTdGF0ZSAmIHsgaW5uZXJTdGF0ZUtleTogc3RyaW5nOyBkZXBlbmRlbmNpZXNLZXk6IHN0cmluZzsgfSB7XG4gICAgY29uc3QgZXh0ZW5zaW9uID0gYC4ke29wdGlvbnMuc291cmNlRXh0IHx8ICdzY3NzJ31gO1xuICAgIHJldHVybiB7XG4gICAgICBzZWxlY3RvcjogKHBhdGg6IHN0cmluZykgPT4gcGF0aC5lbmRzV2l0aChleHRlbnNpb24pLFxuICAgICAgZGVwZW5kZW5jaWVzS2V5OiAnc2Fzcy5kZXBlbmRlbmNpZXMnLFxuICAgICAgaW5uZXJTdGF0ZUtleTogJ3Nhc3MuaW5uZXJTdGF0ZSdcbiAgICB9O1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzYXNzKG9wdGlvbnM/OiBPcHRpb25zKTogRXhlY3V0b3Ige1xuICBpZiAoIW9wdGlvbnMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3RhcmdldFJvb3QgbXVzdCBiZSBzcGVjaWZpZWQnKTtcbiAgfVxuICAvLyBGSVhNRTogcHJvcGFnYXRlXG4gIC8vIGNvbnN0IGluY2x1ZGVQYXRocyA9IG9wdHMuaW5jbHVkZVBhdGhzIHx8IFtdO1xuICBjb25zdCBzYXNzRXhlY3V0b3IgPSBuZXcgU2Fzc01hcHBlcigpLmNyZWF0ZUV4ZWN1dG9yKG9wdGlvbnMpO1xuICBjb25zdCBzYXNzRGVwc0V4ZWN1dG9yID0gbmV3IFNhc3NEZXBlbmRlbmN5UmVzb2x2ZXIoKS5jcmVhdGVFeGVjdXRvcihvcHRpb25zKTtcbiAgcmV0dXJuIEV4ZWN1dG9ycy5jb21iaW5lKHNhc3NFeGVjdXRvciwgc2Fzc0RlcHNFeGVjdXRvcik7XG59Il19