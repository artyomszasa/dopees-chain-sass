"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const s = require("node-sass");
const dopees_chain_1 = require("dopees-chain");
const fs = require("fs");
const fspath = require("path");
const fsp = fs.promises;
// const fileStat = (path: string): Promise<fs.Stats> => new Promise((resolve, reject) => fs.stat(path, (err, stats) => err ? reject(err) : resolve(stats)));
const fileExists = (path) => fsp.access(path).then(() => true, () => false);
const sassRender = (options) => new Promise((resolve, reject) => s.render(options, (err, result) => {
    if (err) {
        reject(err);
    }
    else {
        resolve(result);
    }
}));
const resolveDependency = async (rootPath, path, includePaths) => {
    let folder;
    let fname;
    if (path.includes(fspath.sep)) {
        folder = fspath.dirname(path);
        fname = fspath.basename(path);
    }
    else {
        folder = '';
        fname = path;
    }
    if (!fname.endsWith('.scss')) {
        fname = fname + '.scss';
    }
    for (const basePath of includePaths) {
        let candidate = fspath.normalize(fspath.join(basePath, folder, fname));
        if (await fileExists(candidate)) {
            return candidate;
        }
        if (!fname.startsWith('_')) {
            candidate = fspath.normalize(fspath.join(basePath, folder, '_' + fname));
            if (await fileExists(candidate)) {
                return candidate;
            }
        }
    }
    throw new Error(`could not resolve ${path} while processing ${rootPath}, search paths: ${includePaths}`);
};
const getMatches = (regex, input) => {
    const result = [];
    for (let m = regex.exec(input); m; m = regex.exec(input)) {
        result.push(m);
    }
    return result;
};
class SassMapperState {
    constructor(options) {
        this.sourceResolver = dopees_chain_1.ReversePathResolver.from(options);
        this.innerStateKey = 'sass.innerState';
        const extension = `.${options.targetExt || 'css'}`;
        this.selector = (path, context) => {
            const absoluteTargetRoot = fspath.normalize(fspath.join(context.basePath, options.targetRoot));
            return path.endsWith(extension) && dopees_chain_1.PathResolver.match(path, absoluteTargetRoot, options.subfolders);
        };
        this.outputStyle = options.outputStyle;
        this.precision = options.precision;
        this.production = true === options.production;
    }
}
exports.SassMapperState = SassMapperState;
class SassMapper extends dopees_chain_1.derived.FileMapper {
    constructor() {
        super(...arguments);
        this.name = 'sass';
    }
    async generate(state, task, innerState, _) {
        const options = {
            outputStyle: state.outputStyle || 'compressed',
            precision: state.precision,
            file: innerState.sourcePath,
            data: innerState.sourceCode,
            outFile: task.name.path,
            sourceMap: !state.production,
            sourceMapEmbed: !state.production
        };
        const sassResult = await sassRender(options);
        return sassResult.css;
    }
    async readSource(_, task, context) {
        const code = await context.getContents(task, 'utf-8');
        return {
            sourceCode: code,
            sourcePath: task.name.path
        };
    }
    init(options) { return new SassMapperState(options); }
}
exports.SassMapper = SassMapper;
class SassDependencyResolver extends dopees_chain_1.derived.FileDependencyResolver {
    constructor() {
        super(...arguments);
        this.name = 'sass:deps';
    }
    async readSource(_, task, context) {
        const code = await context.getContents(task, 'utf-8');
        return {
            sourceCode: code,
            sourcePath: task.name.path
        };
    }
    async readDependencies(_, task, innerState, context) {
        const folder = fspath.dirname(innerState.sourcePath);
        return await Promise.all(getMatches(/^@import '(.*)';?$/mg, innerState.sourceCode)
            .map(m => m[1])
            .map(relative => resolveDependency(folder, relative, [folder]))); // FIXME: includePaths
    }
    init(options) {
        const extension = `.${options.sourceExt || 'scss'}`;
        return {
            selector: (path) => path.endsWith(extension),
            dependenciesKey: 'sass.dependencies',
            innerStateKey: 'sass.innerState'
        };
    }
}
exports.SassDependencyResolver = SassDependencyResolver;
function sass(options) {
    if (!options) {
        throw new Error('targetRoot must be specified');
    }
    // FIXME: propagate
    // const includePaths = opts.includePaths || [];
    const sassExecutor = new SassMapper().createExecutor(options);
    const sassDepsExecutor = new SassDependencyResolver().createExecutor(options);
    return dopees_chain_1.Executors.combine(sassExecutor, sassDepsExecutor);
}
exports.sass = sass;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Fzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zYXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQStCO0FBQy9CLCtDQUFpSztBQUNqSyx5QkFBeUI7QUFDekIsK0JBQStCO0FBRS9CLE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUM7QUFFeEIsNkpBQTZKO0FBRTdKLE1BQU0sVUFBVSxHQUFHLENBQUMsSUFBWSxFQUFvQixFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBRXRHLE1BQU0sVUFBVSxHQUFHLENBQUMsT0FBa0IsRUFBcUIsRUFBRSxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLEVBQUU7SUFDL0gsSUFBSSxHQUFHLEVBQUU7UUFDUCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDYjtTQUFNO1FBQ0wsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0tBQ2pCO0FBQ0gsQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUVILE1BQU0saUJBQWlCLEdBQUcsS0FBSyxFQUFFLFFBQWUsRUFBRSxJQUFZLEVBQUUsWUFBc0IsRUFBRSxFQUFFO0lBQ3hGLElBQUksTUFBYyxDQUFDO0lBQ25CLElBQUksS0FBYSxDQUFDO0lBQ2xCLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDN0IsTUFBTSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUIsS0FBSyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7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QzlELE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxzQkFBc0IsRUFBRSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM5RSxPQUFPLHdCQUFTLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO0FBQzNELENBQUM7QUFURCxvQkFTQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHMgZnJvbSAnbm9kZS1zYXNzJztcbmltcG9ydCB7IEV4ZWN1dG9yLCBUYXNrLCBDb250ZXh0LCBGaWxlTmFtZSwgSGVscGVycyBhcyBoLCBSZXZlcnNlUGF0aFJlc29sdmVyQ29uZmlnLCBSZXZlcnNlUGF0aFJlc29sdmVyLCBkZXJpdmVkLCBQYXRoUmVzb2x2ZXIsIEV4ZWN1dG9ycyB9IGZyb20gJ2RvcGVlcy1jaGFpbic7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBmc3BhdGggZnJvbSAncGF0aCc7XG5cbmNvbnN0IGZzcCA9IGZzLnByb21pc2VzO1xuXG4vLyBjb25zdCBmaWxlU3RhdCA9IChwYXRoOiBzdHJpbmcpOiBQcm9taXNlPGZzLlN0YXRzPiA9PiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiBmcy5zdGF0KHBhdGgsIChlcnIsIHN0YXRzKSA9PiBlcnIgPyByZWplY3QoZXJyKSA6IHJlc29sdmUoc3RhdHMpKSk7XG5cbmNvbnN0IGZpbGVFeGlzdHMgPSAocGF0aDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiA9PiBmc3AuYWNjZXNzKHBhdGgpLnRoZW4oKCkgPT4gdHJ1ZSwgKCkgPT4gZmFsc2UpO1xuXG5jb25zdCBzYXNzUmVuZGVyID0gKG9wdGlvbnM6IHMuT3B0aW9ucyk6IFByb21pc2U8cy5SZXN1bHQ+ID0+IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHMucmVuZGVyKG9wdGlvbnMsIChlcnIsIHJlc3VsdCkgPT4ge1xuICBpZiAoZXJyKSB7XG4gICAgcmVqZWN0KGVycik7XG4gIH0gZWxzZSB7XG4gICAgcmVzb2x2ZShyZXN1bHQpO1xuICB9XG59KSlcblxuY29uc3QgcmVzb2x2ZURlcGVuZGVuY3kgPSBhc3luYyAocm9vdFBhdGg6c3RyaW5nLCBwYXRoOiBzdHJpbmcsIGluY2x1ZGVQYXRoczogc3RyaW5nW10pID0+IHtcbiAgbGV0IGZvbGRlcjogc3RyaW5nO1xuICBsZXQgZm5hbWU6IHN0cmluZztcbiAgaWYgKHBhdGguaW5jbHVkZXMoZnNwYXRoLnNlcCkpIHtcbiAgICBmb2xkZXIgPSBmc3BhdGguZGlybmFtZShwYXRoKTtcbiAgICBmbmFtZSA9IGZzcGF0aC5iYXNlbmFtZShwYXRoKTtcbiAgfSBlbHNlIHtcbiAgICBmb2xkZXIgPSAnJztcbiAgICBmbmFtZSA9IHBhdGg7XG4gIH1cbiAgaWYgKCFmbmFtZS5lbmRzV2l0aCgnLnNjc3MnKSkge1xuICAgIGZuYW1lID0gZm5hbWUgKyAnLnNjc3MnO1xuICB9XG4gIGZvciAoY29uc3QgYmFzZVBhdGggb2YgaW5jbHVkZVBhdGhzKSB7XG4gICAgbGV0IGNhbmRpZGF0ZSA9IGZzcGF0aC5ub3JtYWxpemUoZnNwYXRoLmpvaW4oYmFzZVBhdGgsIGZvbGRlciwgZm5hbWUpKTtcbiAgICBpZiAoYXdhaXQgZmlsZUV4aXN0cyhjYW5kaWRhdGUpKSB7XG4gICAgICByZXR1cm4gY2FuZGlkYXRlO1xuICAgIH1cbiAgICBpZiAoIWZuYW1lLnN0YXJ0c1dpdGgoJ18nKSkge1xuICAgICAgY2FuZGlkYXRlID0gZnNwYXRoLm5vcm1hbGl6ZShmc3BhdGguam9pbihiYXNlUGF0aCwgZm9sZGVyLCAnXycgKyBmbmFtZSkpO1xuICAgICAgaWYgKGF3YWl0IGZpbGVFeGlzdHMoY2FuZGlkYXRlKSkge1xuICAgICAgICByZXR1cm4gY2FuZGlkYXRlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoYGNvdWxkIG5vdCByZXNvbHZlICR7cGF0aH0gd2hpbGUgcHJvY2Vzc2luZyAke3Jvb3RQYXRofSwgc2VhcmNoIHBhdGhzOiAke2luY2x1ZGVQYXRoc31gKTtcbn1cblxuY29uc3QgZ2V0TWF0Y2hlcyA9IChyZWdleDogUmVnRXhwLCBpbnB1dDogc3RyaW5nKSA9PiB7XG4gIGNvbnN0IHJlc3VsdCA9IFtdO1xuICBmb3IgKGxldCBtID0gcmVnZXguZXhlYyhpbnB1dCk7IG07IG0gPSByZWdleC5leGVjKGlucHV0KSkge1xuICAgIHJlc3VsdC5wdXNoKG0pO1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmludGVyZmFjZSBEZXBlbmRlbmNpZXMge1xuICByZWFkb25seSBtdGltZTogRGF0ZTtcbiAgcmVhZG9ubHkgZGVwczogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgT3B0aW9ucyBleHRlbmRzIFJldmVyc2VQYXRoUmVzb2x2ZXJDb25maWcge1xuICB0YXJnZXRSb290OiBzdHJpbmc7XG4gIHN1YmZvbGRlcnM/OiBib29sZWFuO1xuICAvL3NvdXJjZVJlc29sdmVyPzogKHBhdGg6IHN0cmluZywgYmFzZVBhdGg/OiBzdHJpbmcpID0+IHN0cmluZztcbiAgaW5jbHVkZVBhdGhzPzogc3RyaW5nW107XG4gIG91dHB1dFN0eWxlPzogXCJjb21wYWN0XCIgfCBcImNvbXByZXNzZWRcIiB8IFwiZXhwYW5kZWRcIiB8IFwibmVzdGVkXCI7XG4gIHByZWNpc2lvbj86IG51bWJlcjtcbiAgcGVyc2lzdHM/OiBib29sZWFuO1xuICBwcm9kdWN0aW9uPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGNsYXNzIFNhc3NNYXBwZXJTdGF0ZSBpbXBsZW1lbnRzIGRlcml2ZWQuRmlsZU1hcHBlclN0YXRlIHtcbiAgc291cmNlUmVzb2x2ZXI6IFBhdGhSZXNvbHZlcjtcbiAgaW5uZXJTdGF0ZUtleTogc3RyaW5nO1xuICBzZWxlY3RvcjogKHBhdGg6IHN0cmluZywgY29udGV4dDogQ29udGV4dCkgPT4gYm9vbGVhbjtcbiAgb3V0cHV0U3R5bGU/OiBcImNvbXBhY3RcIiB8IFwiY29tcHJlc3NlZFwiIHwgXCJleHBhbmRlZFwiIHwgXCJuZXN0ZWRcIjtcbiAgcHJlY2lzaW9uPzogbnVtYmVyO1xuICBwcm9kdWN0aW9uOiBib29sZWFuO1xuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBPcHRpb25zKSB7XG4gICAgdGhpcy5zb3VyY2VSZXNvbHZlciA9IFJldmVyc2VQYXRoUmVzb2x2ZXIuZnJvbShvcHRpb25zKTtcbiAgICB0aGlzLmlubmVyU3RhdGVLZXkgPSAnc2Fzcy5pbm5lclN0YXRlJztcbiAgICBjb25zdCBleHRlbnNpb24gPSBgLiR7b3B0aW9ucy50YXJnZXRFeHQgfHwgJ2Nzcyd9YDtcbiAgICB0aGlzLnNlbGVjdG9yID0gKHBhdGg6IHN0cmluZywgY29udGV4dDogQ29udGV4dCkgPT4ge1xuICAgICAgY29uc3QgYWJzb2x1dGVUYXJnZXRSb290ID0gZnNwYXRoLm5vcm1hbGl6ZShmc3BhdGguam9pbihjb250ZXh0LmJhc2VQYXRoLCBvcHRpb25zLnRhcmdldFJvb3QpKTtcbiAgICAgIHJldHVybiBwYXRoLmVuZHNXaXRoKGV4dGVuc2lvbikgJiYgUGF0aFJlc29sdmVyLm1hdGNoKHBhdGgsIGFic29sdXRlVGFyZ2V0Um9vdCwgb3B0aW9ucy5zdWJmb2xkZXJzKTtcbiAgICB9O1xuICAgIHRoaXMub3V0cHV0U3R5bGUgPSBvcHRpb25zLm91dHB1dFN0eWxlO1xuICAgIHRoaXMucHJlY2lzaW9uID0gb3B0aW9ucy5wcmVjaXNpb25cbiAgICB0aGlzLnByb2R1Y3Rpb24gPSB0cnVlID09PSBvcHRpb25zLnByb2R1Y3Rpb247XG4gIH1cbn1cblxuaW50ZXJmYWNlIFNhc3NJbm5lclN0YXRlIHtcbiAgcmVhZG9ubHkgc291cmNlQ29kZTogc3RyaW5nO1xuICByZWFkb25seSBzb3VyY2VQYXRoOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBTYXNzTWFwcGVyIGV4dGVuZHMgZGVyaXZlZC5GaWxlTWFwcGVyPE9wdGlvbnMsIFNhc3NJbm5lclN0YXRlLCBTYXNzTWFwcGVyU3RhdGU+ICB7XG4gIG5hbWUgPSAnc2Fzcyc7XG4gIHByb3RlY3RlZCBhc3luYyBnZW5lcmF0ZShzdGF0ZTogU2Fzc01hcHBlclN0YXRlLCB0YXNrOiBUYXNrLCBpbm5lclN0YXRlOiBTYXNzSW5uZXJTdGF0ZSwgXzogQ29udGV4dCkge1xuICAgIGNvbnN0IG9wdGlvbnMgOiBzLk9wdGlvbnMgPSB7XG4gICAgICBvdXRwdXRTdHlsZTogc3RhdGUub3V0cHV0U3R5bGUgfHwgJ2NvbXByZXNzZWQnLFxuICAgICAgcHJlY2lzaW9uOiBzdGF0ZS5wcmVjaXNpb24sXG4gICAgICBmaWxlOiBpbm5lclN0YXRlLnNvdXJjZVBhdGgsXG4gICAgICBkYXRhOiBpbm5lclN0YXRlLnNvdXJjZUNvZGUsXG4gICAgICBvdXRGaWxlOiAoPEZpbGVOYW1lPnRhc2submFtZSkucGF0aCxcbiAgICAgIHNvdXJjZU1hcDogIXN0YXRlLnByb2R1Y3Rpb24sXG4gICAgICBzb3VyY2VNYXBFbWJlZDogIXN0YXRlLnByb2R1Y3Rpb25cbiAgICB9O1xuICAgIGNvbnN0IHNhc3NSZXN1bHQgPSBhd2FpdCBzYXNzUmVuZGVyKG9wdGlvbnMpO1xuICAgIHJldHVybiBzYXNzUmVzdWx0LmNzcztcbiAgfVxuICBwcm90ZWN0ZWQgYXN5bmMgcmVhZFNvdXJjZShfOiBTYXNzTWFwcGVyU3RhdGUsIHRhc2s6IFRhc2ssIGNvbnRleHQ6IENvbnRleHQpIHtcbiAgICBjb25zdCBjb2RlID0gYXdhaXQgY29udGV4dC5nZXRDb250ZW50cyh0YXNrLCAndXRmLTgnKTtcbiAgICByZXR1cm4ge1xuICAgICAgc291cmNlQ29kZTogY29kZSxcbiAgICAgIHNvdXJjZVBhdGg6ICg8RmlsZU5hbWU+dGFzay5uYW1lKS5wYXRoXG4gICAgfTtcbiAgfVxuICBwcm90ZWN0ZWQgaW5pdChvcHRpb25zOiBPcHRpb25zKTogU2Fzc01hcHBlclN0YXRlIHsgcmV0dXJuIG5ldyBTYXNzTWFwcGVyU3RhdGUob3B0aW9ucyk7IH1cbn1cblxuZXhwb3J0IGNsYXNzIFNhc3NEZXBlbmRlbmN5UmVzb2x2ZXIgZXh0ZW5kcyBkZXJpdmVkLkZpbGVEZXBlbmRlbmN5UmVzb2x2ZXI8eyBzb3VyY2VFeHQ/OiBzdHJpbmcgfSwgU2Fzc0lubmVyU3RhdGUsIGRlcml2ZWQuRmlsZURlcGVuZGVuY3lSZXNvbHZlclN0YXRlICYgeyBpbm5lclN0YXRlS2V5OiBzdHJpbmcsIGRlcGVuZGVuY2llc0tleTogc3RyaW5nIH0+IHtcbiAgbmFtZSA9ICdzYXNzOmRlcHMnO1xuICBwcm90ZWN0ZWQgYXN5bmMgcmVhZFNvdXJjZShfOiBkZXJpdmVkLkZpbGVEZXBlbmRlbmN5UmVzb2x2ZXJTdGF0ZSAmIHsgaW5uZXJTdGF0ZUtleTogc3RyaW5nOyBkZXBlbmRlbmNpZXNLZXk6IHN0cmluZzsgfSwgdGFzazogVGFzaywgY29udGV4dDogQ29udGV4dCk6IFByb21pc2U8U2Fzc0lubmVyU3RhdGU+IHtcbiAgICBjb25zdCBjb2RlID0gYXdhaXQgY29udGV4dC5nZXRDb250ZW50cyh0YXNrLCAndXRmLTgnKTtcbiAgICByZXR1cm4ge1xuICAgICAgc291cmNlQ29kZTogY29kZSxcbiAgICAgIHNvdXJjZVBhdGg6ICg8RmlsZU5hbWU+dGFzay5uYW1lKS5wYXRoXG4gICAgfTtcbiAgfVxuICBwcm90ZWN0ZWQgYXN5bmMgcmVhZERlcGVuZGVuY2llcyhfOiBkZXJpdmVkLkZpbGVEZXBlbmRlbmN5UmVzb2x2ZXJTdGF0ZSAmIHsgaW5uZXJTdGF0ZUtleTogc3RyaW5nOyBkZXBlbmRlbmNpZXNLZXk6IHN0cmluZzsgfSwgdGFzazogVGFzaywgaW5uZXJTdGF0ZTogU2Fzc0lubmVyU3RhdGUsIGNvbnRleHQ6IENvbnRleHQpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgZm9sZGVyID0gZnNwYXRoLmRpcm5hbWUoaW5uZXJTdGF0ZS5zb3VyY2VQYXRoKTtcbiAgICByZXR1cm4gYXdhaXQgUHJvbWlzZS5hbGwoZ2V0TWF0Y2hlcygvXkBpbXBvcnQgJyguKiknOz8kL21nLCBpbm5lclN0YXRlLnNvdXJjZUNvZGUpXG4gICAgICAubWFwKG0gPT4gbVsxXSlcbiAgICAgIC5tYXAocmVsYXRpdmUgPT4gcmVzb2x2ZURlcGVuZGVuY3koZm9sZGVyLCByZWxhdGl2ZSwgWyBmb2xkZXIgXSkpKTsgLy8gRklYTUU6IGluY2x1ZGVQYXRoc1xuICB9XG4gIHByb3RlY3RlZCBpbml0KG9wdGlvbnM6IHsgc291cmNlRXh0Pzogc3RyaW5nIH0pOiBkZXJpdmVkLkZpbGVEZXBlbmRlbmN5UmVzb2x2ZXJTdGF0ZSAmIHsgaW5uZXJTdGF0ZUtleTogc3RyaW5nOyBkZXBlbmRlbmNpZXNLZXk6IHN0cmluZzsgfSB7XG4gICAgY29uc3QgZXh0ZW5zaW9uID0gYC4ke29wdGlvbnMuc291cmNlRXh0IHx8ICdzY3NzJ31gO1xuICAgIHJldHVybiB7XG4gICAgICBzZWxlY3RvcjogKHBhdGg6IHN0cmluZykgPT4gcGF0aC5lbmRzV2l0aChleHRlbnNpb24pLFxuICAgICAgZGVwZW5kZW5jaWVzS2V5OiAnc2Fzcy5kZXBlbmRlbmNpZXMnLFxuICAgICAgaW5uZXJTdGF0ZUtleTogJ3Nhc3MuaW5uZXJTdGF0ZSdcbiAgICB9O1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzYXNzKG9wdGlvbnM/OiBPcHRpb25zKTogRXhlY3V0b3Ige1xuICBpZiAoIW9wdGlvbnMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3RhcmdldFJvb3QgbXVzdCBiZSBzcGVjaWZpZWQnKTtcbiAgfVxuICAvLyBGSVhNRTogcHJvcGFnYXRlXG4gIC8vIGNvbnN0IGluY2x1ZGVQYXRocyA9IG9wdHMuaW5jbHVkZVBhdGhzIHx8IFtdO1xuICBjb25zdCBzYXNzRXhlY3V0b3IgPSBuZXcgU2Fzc01hcHBlcigpLmNyZWF0ZUV4ZWN1dG9yKG9wdGlvbnMpO1xuICBjb25zdCBzYXNzRGVwc0V4ZWN1dG9yID0gbmV3IFNhc3NEZXBlbmRlbmN5UmVzb2x2ZXIoKS5jcmVhdGVFeGVjdXRvcihvcHRpb25zKTtcbiAgcmV0dXJuIEV4ZWN1dG9ycy5jb21iaW5lKHNhc3NFeGVjdXRvciwgc2Fzc0RlcHNFeGVjdXRvcik7XG59Il19